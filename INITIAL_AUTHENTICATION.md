# INITIAL_AUTHENTICATION.md - Syst√®me d'Authentification Dashboard

## üéØ Vue d'ensemble

Ce document d√©taille l'architecture compl√®te d'authentification pour s√©curiser le dashboard Voipia. Le syst√®me utilise **Supabase Auth**, qui g√®re automatiquement les utilisateurs, mots de passe, tokens JWT, et sessions. Vous n'avez **pas besoin** de cr√©er votre propre syst√®me de stockage de mots de passe ou de tokens.

### Objectifs

- **S√©curit√©** : Seuls les utilisateurs autoris√©s peuvent acc√©der au dashboard
- **Multi-tenant** : Chaque utilisateur ne voit que les clients qui lui sont assign√©s
- **UX fluide** : Login rapide, sessions persistantes, logout propre
- **Production-ready** : Sessions s√©curis√©es, refresh automatique des tokens, protection CSRF

---

## üìã Architecture d'Authentification

### Comment fonctionne Supabase Auth ?

Supabase Auth est un service d'authentification complet inclus dans Supabase :

**Ce que Supabase Auth g√®re pour vous** :
- ‚úÖ Stockage s√©curis√© des mots de passe (bcrypt)
- ‚úÖ G√©n√©ration et gestion des JWT tokens
- ‚úÖ Refresh automatique des tokens
- ‚úÖ Sessions utilisateur
- ‚úÖ Email de confirmation (optionnel)
- ‚úÖ Reset de mot de passe
- ‚úÖ OAuth providers (Google, GitHub, etc.) - optionnel
- ‚úÖ Protection contre le brute force

**Ce que vous g√©rez** :
- ‚ùå Rien au niveau du stockage des credentials
- ‚úÖ Uniquement les **permissions** (qui peut voir quels clients)
- ‚úÖ L'interface de login
- ‚úÖ Le middleware de protection des routes

### Tables Supabase

**Table `auth.users`** (g√©r√©e par Supabase Auth) :
- Cr√©√©e et g√©r√©e automatiquement
- Stocke : email, encrypted password, metadata
- Vous n'y touchez jamais directement

**Table `user_client_permissions`** (d√©j√† cr√©√©e) :
- Lie les users aux clients
- D√©finit les permissions (read, write, admin)
- C'est **votre** table de business logic

**Table `profiles`** (√† cr√©er - optionnel) :
- Informations publiques de l'utilisateur
- R√¥le global (admin, user)
- Pr√©f√©rences UI

---

## üîê Flow d'Authentification Complet

### 1. Utilisateur non connect√© visite `/dashboard`

```
User ‚Üí /dashboard
       ‚Üì
Middleware v√©rifie session
       ‚Üì
Pas de session valide
       ‚Üì
Redirect ‚Üí /login
```

### 2. Page de Login (`/login`)

**Interface** :
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üîê Connexion Dashboard Voipia  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Email:    [________________]   ‚îÇ
‚îÇ  Password: [________________]   ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  [ Se connecter ]               ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  Mot de passe oubli√© ?          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Code (simplifi√©)** :
```typescript
// app/login/page.tsx
'use client'

import { useState } from 'react'
import { createClient } from '@/lib/supabase/client'
import { useRouter } from 'next/navigation'

export default function LoginPage() {
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [error, setError] = useState('')
  const router = useRouter()
  const supabase = createClient()

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault()
    setError('')

    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
    })

    if (error) {
      setError(error.message)
      return
    }

    // Succ√®s ‚Üí redirect vers dashboard
    router.push('/dashboard')
    router.refresh() // Force refresh pour recharger le middleware
  }

  return (
    <form onSubmit={handleLogin}>
      {/* UI de login */}
    </form>
  )
}
```

### 3. Supabase Auth Process (automatique)

```
User submit login form
       ‚Üì
supabase.auth.signInWithPassword()
       ‚Üì
Supabase v√©rifie email/password
       ‚Üì
Si valide : g√©n√®re JWT + refresh token
       ‚Üì
Stocke tokens dans cookies httpOnly
       ‚Üì
Retourne session au client
```

**Important** : Les tokens sont stock√©s dans des **cookies httpOnly** (s√©curis√©s, inaccessibles en JavaScript).

### 4. Middleware v√©rifie la session

```typescript
// middleware.ts
import { createServerClient } from '@supabase/ssr'
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export async function middleware(request: NextRequest) {
  let response = NextResponse.next({ request })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll()
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) =>
            response.cookies.set(name, value, options)
          )
        },
      },
    }
  )

  // Refresh session automatiquement
  const { data: { user } } = await supabase.auth.getUser()

  // Si pas de user et route prot√©g√©e ‚Üí redirect login
  if (!user && request.nextUrl.pathname.startsWith('/dashboard')) {
    return NextResponse.redirect(new URL('/login', request.url))
  }

  // Si user existe et est sur /login ‚Üí redirect dashboard
  if (user && request.nextUrl.pathname === '/login') {
    return NextResponse.redirect(new URL('/dashboard', request.url))
  }

  return response
}

export const config = {
  matcher: [
    '/dashboard/:path*',
    '/login',
  ]
}
```

### 5. Acc√®s au Dashboard s√©curis√©

```
User authentifi√© ‚Üí /dashboard
       ‚Üì
Middleware v√©rifie session (OK)
       ‚Üì
Page charge
       ‚Üì
Server Component fetch data avec RLS
       ‚Üì
PostgreSQL applique les policies RLS
       ‚Üì
User voit UNIQUEMENT ses clients assign√©s
```

**RLS Policy (d√©j√† cr√©√©e)** :
```sql
-- L'utilisateur ne voit QUE les appels de ses clients assign√©s
CREATE POLICY "users_view_their_calls"
  ON calls FOR SELECT
  TO authenticated
  USING (
    client_id IN (
      SELECT client_id
      FROM user_client_permissions
      WHERE user_id = auth.uid()  -- ‚Üê JWT automatiquement v√©rifi√©
    )
  );
```

### 6. Logout

```typescript
// components/LogoutButton.tsx
'use client'

import { createClient } from '@/lib/supabase/client'
import { useRouter } from 'next/navigation'

export function LogoutButton() {
  const router = useRouter()
  const supabase = createClient()

  const handleLogout = async () => {
    await supabase.auth.signOut()
    router.push('/login')
    router.refresh()
  }

  return (
    <button onClick={handleLogout}>
      D√©connexion
    </button>
  )
}
```

---

## üóÇÔ∏è Structure des Fichiers

### Nouveaux fichiers √† cr√©er

```
app/
‚îú‚îÄ‚îÄ login/
‚îÇ   ‚îî‚îÄ‚îÄ page.tsx           # Page de login
‚îú‚îÄ‚îÄ logout/
‚îÇ   ‚îî‚îÄ‚îÄ route.ts          # API route pour logout (optionnel)
‚îî‚îÄ‚îÄ middleware.ts          # Protection des routes (ROOT LEVEL)

components/
‚îî‚îÄ‚îÄ auth/
    ‚îú‚îÄ‚îÄ LoginForm.tsx      # Formulaire de login
    ‚îî‚îÄ‚îÄ LogoutButton.tsx   # Bouton d√©connexion

lib/
‚îî‚îÄ‚îÄ auth/
    ‚îî‚îÄ‚îÄ session.ts        # Helpers pour g√©rer la session
```

### Middleware (IMPORTANT)

Le fichier `middleware.ts` doit √™tre √† la **racine du projet**, pas dans `app/` :

```
voipia-landing/
‚îú‚îÄ‚îÄ app/
‚îú‚îÄ‚îÄ components/
‚îú‚îÄ‚îÄ lib/
‚îú‚îÄ‚îÄ middleware.ts  ‚Üê ICI (niveau racine)
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ ...
```

---

## üë§ Gestion des Utilisateurs

### Table `profiles` (√† cr√©er)

Cette table stocke les informations publiques de l'utilisateur :

```sql
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT NOT NULL,
  full_name TEXT,
  role TEXT DEFAULT 'user' CHECK (role IN ('user', 'admin')),
  avatar_url TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

-- Policy : Les users voient leur propre profil
CREATE POLICY "users_view_own_profile"
  ON profiles FOR SELECT
  TO authenticated
  USING (id = auth.uid());

-- Policy : Les users peuvent update leur propre profil
CREATE POLICY "users_update_own_profile"
  ON profiles FOR UPDATE
  TO authenticated
  USING (id = auth.uid())
  WITH CHECK (id = auth.uid());
```

### Trigger de cr√©ation automatique du profil

Quand un user est cr√©√© dans `auth.users`, cr√©er automatiquement son profil :

```sql
-- Function
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, email, full_name)
  VALUES (
    NEW.id,
    NEW.email,
    NEW.raw_user_meta_data->>'full_name'
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION public.handle_new_user();
```

### Assigner des permissions √† un utilisateur

**Sc√©nario** : Vous cr√©ez un user et voulez lui donner acc√®s √† certains clients.

**Via Supabase Dashboard** :
1. Authentication ‚Üí Users ‚Üí Add user
2. Cr√©er l'utilisateur (email + password)
3. Copier le `user_id` (UUID)

**Via SQL** :
```sql
-- Donner acc√®s au client "Voipia" √† l'utilisateur
INSERT INTO user_client_permissions (user_id, client_id, permission_level)
VALUES (
  '123e4567-e89b-12d3-a456-426614174000',  -- user_id copi√©
  (SELECT id FROM clients WHERE name = 'Voipia'),
  'admin'
);
```

**Via API (automatis√©)** :
```typescript
// app/api/admin/assign-client/route.ts
export async function POST(request: Request) {
  const { userId, clientId, permissionLevel } = await request.json()

  const supabase = createServerClient(...)

  // V√©rifier que le user actuel est admin
  const { data: { user } } = await supabase.auth.getUser()
  const { data: profile } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', user.id)
    .single()

  if (profile?.role !== 'admin') {
    return Response.json({ error: 'Unauthorized' }, { status: 403 })
  }

  // Assigner permission
  const { error } = await supabase
    .from('user_client_permissions')
    .insert({ user_id: userId, client_id: clientId, permission_level: permissionLevel })

  if (error) {
    return Response.json({ error: error.message }, { status: 400 })
  }

  return Response.json({ success: true })
}
```

---

## üé® UI/UX d'Authentification

### Page de Login

**Design recommand√©** :

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                            ‚îÇ
‚îÇ         üîê Connexion Dashboard             ‚îÇ
‚îÇ                                            ‚îÇ
‚îÇ  Acc√©dez √† vos statistiques d'agents IA   ‚îÇ
‚îÇ                                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ Email                              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ [____________________________]     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ Mot de passe                       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ [____________________________] üëÅ  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ [ Se connecter ]                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ Mot de passe oubli√© ?              ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                            ‚îÇ
‚îÇ  ‚ö†Ô∏è Si erreur : "Email ou mot de passe    ‚îÇ
‚îÇ     incorrect"                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Fonctionnalit√©s** :
- ‚úÖ Validation email format
- ‚úÖ Toggle show/hide password
- ‚úÖ Loading state pendant login
- ‚úÖ Messages d'erreur clairs
- ‚úÖ Responsive mobile
- ‚úÖ Lien "Mot de passe oubli√©" (vers `/reset-password`)

### Bouton Logout dans le Dashboard

**Emplacement** : Header du dashboard, en haut √† droite

```typescript
<header className="flex justify-between items-center mb-8">
  <div>
    <h1>Dashboard Analytics</h1>
    <p className="text-sm text-white/60">
      Connect√© en tant que {user.email}
    </p>
  </div>

  <LogoutButton />
</header>
```

---

## üîí S√©curit√© Best Practices

### 1. Variables d'environnement

**Ne JAMAIS commiter** :
- ‚ùå Service role key (admin access)
- ‚ùå Database passwords

**Peut √™tre public** (d√©j√† dans votre code) :
- ‚úÖ `NEXT_PUBLIC_SUPABASE_URL`
- ‚úÖ `NEXT_PUBLIC_SUPABASE_ANON_KEY` (lecture seule avec RLS)

### 2. Row Level Security (RLS)

**OBLIGATOIRE sur toutes les tables** :
```sql
ALTER TABLE calls ENABLE ROW LEVEL SECURITY;
ALTER TABLE clients ENABLE ROW LEVEL SECURITY;
ALTER TABLE agents ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_client_permissions ENABLE ROW LEVEL SECURITY;
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
```

Sans RLS, m√™me avec authentification, **tous les users pourraient voir toutes les donn√©es**.

### 3. JWT Validation

Le middleware utilise `getUser()` qui :
- ‚úÖ V√©rifie la signature du JWT
- ‚úÖ V√©rifie l'expiration
- ‚úÖ Refresh automatiquement si n√©cessaire
- ‚úÖ Retourne `null` si invalide

**Ne JAMAIS utiliser** `getSession()` seul :
```typescript
// ‚ùå MAUVAIS - Ne v√©rifie pas le JWT c√¥t√© serveur
const { data: { session } } = await supabase.auth.getSession()

// ‚úÖ BON - V√©rifie le JWT avec la cl√© secr√®te
const { data: { user } } = await supabase.auth.getUser()
```

### 4. HTTPS en production

Les cookies `httpOnly` et `secure` n√©cessitent HTTPS. En dev (localhost), HTTP est OK.

### 5. Rate Limiting (optionnel)

Prot√©ger contre le brute force sur `/login` :

**Option A** : Supabase Auth inclut d√©j√† un rate limiting basique

**Option B** : Ajouter Vercel Rate Limiting :
```typescript
import { ratelimit } from '@/lib/ratelimit'

export async function POST(request: Request) {
  const ip = request.headers.get('x-forwarded-for') ?? 'unknown'
  const { success } = await ratelimit.limit(ip)

  if (!success) {
    return Response.json({ error: 'Too many requests' }, { status: 429 })
  }

  // ... login logic
}
```

---

## üß™ Tests d'Authentification

### Sc√©narios √† tester

**Test 1 - Login r√©ussi** :
1. Cr√©er un user de test dans Supabase
2. Aller sur `/login`
3. Entrer email/password valides
4. V√©rifier redirect vers `/dashboard`
5. V√©rifier que les donn√©es s'affichent

**Test 2 - Login √©chou√©** :
1. Aller sur `/login`
2. Entrer mauvais password
3. V√©rifier message d'erreur
4. V√©rifier pas de redirect

**Test 3 - Acc√®s direct sans auth** :
1. En navigation priv√©e (pas de session)
2. Aller directement sur `/dashboard`
3. V√©rifier redirect vers `/login`

**Test 4 - RLS** :
1. Se connecter avec user A (acc√®s client X)
2. V√©rifier qu'on voit seulement les donn√©es du client X
3. Se d√©connecter
4. Se connecter avec user B (acc√®s client Y)
5. V√©rifier qu'on voit seulement les donn√©es du client Y

**Test 5 - Logout** :
1. Se connecter
2. Cliquer sur Logout
3. V√©rifier redirect vers `/login`
4. Essayer d'acc√©der √† `/dashboard` ‚Üí doit redirect vers `/login`

**Test 6 - Session refresh** :
1. Se connecter
2. Attendre 1 heure (ou modifier l'expiration JWT pour tester)
3. Naviguer dans le dashboard
4. V√©rifier que la session se refresh automatiquement

---

## üìä Flow Diagrams

### Diagramme de S√©quence : Premier Login

```
User          Browser         Next.js         Supabase Auth      PostgreSQL
 |               |               |                  |                 |
 |--Visit /dashboard------------>|                  |                 |
 |               |               |                  |                 |
 |               |<---Middleware checks session-----|                 |
 |               |               |                  |                 |
 |               |<--No session, redirect /login----|                 |
 |               |               |                  |                 |
 |--Enter credentials----------->|                  |                 |
 |               |               |                  |                 |
 |               |--signInWithPassword------------->|                 |
 |               |               |                  |                 |
 |               |               |                  |--Verify hash--->|
 |               |               |                  |<--User valid----|
 |               |               |                  |                 |
 |               |               |<--JWT + cookies--|                 |
 |               |               |                  |                 |
 |<--Redirect /dashboard---------|                  |                 |
 |               |               |                  |                 |
 |--Visit /dashboard------------>|                  |                 |
 |               |               |                  |                 |
 |               |<---Middleware verifies JWT------>|                 |
 |               |               |                  |                 |
 |               |--Fetch data with user context------------------->|
 |               |               |                  |                 |
 |               |               |<--RLS filtered data---------------|
 |               |               |                  |                 |
 |<--Dashboard renders-----------|                  |                 |
```

### Diagramme de Flow : D√©cisions du Middleware

```
                    Request arrives
                           ‚Üì
                    Extract cookies
                           ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ   supabase.auth.getUser() ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
                   User exists?
                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                ‚îÇ                     ‚îÇ
               YES                   NO
                ‚îÇ                     ‚îÇ
                ‚Üì                     ‚Üì
        Is on /login?         Is on protected route?
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       YES            NO     YES            NO
        ‚îÇ              ‚îÇ      ‚îÇ              ‚îÇ
        ‚Üì              ‚Üì      ‚Üì              ‚Üì
   Redirect      Allow    Redirect      Allow
   /dashboard    access   /login        access
```

---

## üöÄ Roadmap d'Impl√©mentation

### Phase 1 : Setup Supabase Auth (30 min)

1. **Cr√©er la table `profiles`** (SQL)
2. **Cr√©er le trigger `handle_new_user`** (SQL)
3. **Cr√©er un utilisateur de test** (Supabase Dashboard)
4. **Lui assigner un client** (SQL)

### Phase 2 : Pages d'Authentification (2h)

1. **Cr√©er `/app/login/page.tsx`**
2. **Cr√©er `LoginForm` component**
3. **Cr√©er `LogoutButton` component**
4. **Tester le login/logout**

### Phase 3 : Middleware (1h)

1. **Cr√©er `/middleware.ts`**
2. **Tester la protection de `/dashboard`**
3. **Tester le redirect automatique**

### Phase 4 : UX Polish (1h)

1. **Ajouter loading states**
2. **Ajouter error handling**
3. **Ajouter "Mot de passe oubli√©"** (optionnel)
4. **Responsive design**

### Phase 5 : Tests (1h)

1. **Tester tous les sc√©narios**
2. **V√©rifier RLS**
3. **Tester en navigation priv√©e**

**Temps total estim√© : 5-6 heures**

---

## ‚ö†Ô∏è Points Importants

### 1. Pas besoin de g√©rer les passwords

Supabase Auth fait tout :
- ‚úÖ Hashing bcrypt automatique
- ‚úÖ Salt unique par user
- ‚úÖ Validation de force de password (configurable)
- ‚úÖ Protection brute force

Vous ne touchez **JAMAIS** aux passwords en clair.

### 2. Les JWT sont automatiques

Quand un user se connecte :
1. Supabase g√©n√®re un JWT sign√©
2. Le JWT contient : `user_id`, `email`, `role`, `exp`
3. Le JWT est stock√© dans un cookie `httpOnly`
4. PostgreSQL peut lire le JWT via `auth.uid()`

### 3. RLS est la cl√© de la s√©curit√©

M√™me si un user modifie le frontend en JavaScript, les RLS policies PostgreSQL l'emp√™chent de voir des donn√©es non autoris√©es.

```sql
-- Cette policy s'applique TOUJOURS, m√™me si le code frontend est hack√©
CREATE POLICY "users_view_their_calls"
  ON calls FOR SELECT
  TO authenticated
  USING (
    client_id IN (
      SELECT client_id FROM user_client_permissions
      WHERE user_id = auth.uid()  -- V√©rifi√© par PostgreSQL
    )
  );
```

### 4. Middleware vs RLS

**Middleware** :
- Emp√™che l'acc√®s √† la **page** `/dashboard`
- Redirect vers `/login` si pas connect√©
- UX (√©vite de charger la page pour rien)

**RLS** :
- Emp√™che l'acc√®s aux **donn√©es** dans PostgreSQL
- S√©curit√© (m√™me si middleware bypass√©)
- OBLIGATOIRE

Les deux sont n√©cessaires et compl√©mentaires.

---

## üìù Fichier de Configuration

### Supabase Dashboard Settings

**Auth Settings √† configurer** :

1. **Email Auth** : ‚úÖ Activ√© (par d√©faut)
2. **Email Confirmation** : ‚ùå D√©sactiv√© (ou ‚úÖ si vous voulez)
3. **Password Requirements** :
   - Minimum length : 8 caract√®res
   - Require uppercase : Optionnel
   - Require numbers : Recommand√©
4. **Session Settings** :
   - JWT Expiry : 3600 (1 heure)
   - Refresh Token Expiry : 2592000 (30 jours)

**Acc√®s** : Supabase Dashboard ‚Üí Authentication ‚Üí Settings

---

## üéØ Exemple Complet : Cr√©ation d'un Utilisateur

### √âtape 1 : Cr√©er l'utilisateur dans Supabase

**Via Dashboard** :
1. Authentication ‚Üí Users ‚Üí Add user
2. Email : `jean.dupont@example.com`
3. Password : `SecurePass123!`
4. Auto Confirm : ‚úÖ Oui
5. Cr√©er

**Le trigger `handle_new_user` cr√©era automatiquement le profil**.

### √âtape 2 : Assigner des permissions

```sql
-- Trouver l'user_id
SELECT id, email FROM auth.users WHERE email = 'jean.dupont@example.com';

-- R√©sultat : id = 'abc-123-def-456'

-- Assigner acc√®s au client "Voipia"
INSERT INTO user_client_permissions (user_id, client_id, permission_level)
VALUES (
  'abc-123-def-456',
  (SELECT id FROM clients WHERE name = 'Voipia'),
  'read'
);

-- Assigner acc√®s √† un second client "Exotic Design"
INSERT INTO user_client_permissions (user_id, client_id, permission_level)
VALUES (
  'abc-123-def-456',
  (SELECT id FROM clients WHERE name = 'Exotic Design'),
  'admin'
);
```

### √âtape 3 : L'utilisateur se connecte

1. Va sur `/login`
2. Entre `jean.dupont@example.com` / `SecurePass123!`
3. Clique "Se connecter"
4. Est redirect√© vers `/dashboard`
5. Voit **uniquement** les donn√©es de "Voipia" et "Exotic Design"

---

## ‚úÖ Checklist de Production

Avant de d√©ployer en production :

- [ ] RLS activ√© sur **toutes** les tables
- [ ] Policies test√©es avec diff√©rents users
- [ ] Middleware prot√®ge toutes les routes sensibles
- [ ] HTTPS activ√© (Vercel le fait automatiquement)
- [ ] Variables d'environnement configur√©es sur Vercel
- [ ] Email confirmation activ√© (si souhait√©)
- [ ] Rate limiting configur√© (optionnel)
- [ ] Logs d'authentification monitor√©s
- [ ] Backup r√©gulier de `user_client_permissions`

---

## üÜò Troubleshooting

### Probl√®me : "Redirect loop entre /login et /dashboard"

**Cause** : Le middleware ne d√©tecte pas correctement l'utilisateur.

**Solution** :
```typescript
// Utiliser getUser() pas getSession()
const { data: { user } } = await supabase.auth.getUser()  // ‚úÖ
// PAS
const { data: { session } } = await supabase.auth.getSession()  // ‚ùå
```

### Probl√®me : "User connect√© mais voit aucune donn√©e"

**Cause** : Pas de permissions assign√©es dans `user_client_permissions`.

**Solution** :
```sql
-- V√©rifier les permissions
SELECT * FROM user_client_permissions WHERE user_id = 'user-id-here';

-- Si vide, assigner
INSERT INTO user_client_permissions (user_id, client_id, permission_level)
VALUES ('user-id', 'client-id', 'read');
```

### Probl√®me : "Token expired"

**Cause** : Le refresh du token a √©chou√©.

**Solution** : Le middleware g√®re normalement le refresh automatiquement. Si probl√®me persiste :
```typescript
// Forcer un refresh
await supabase.auth.refreshSession()
```

### Probl√®me : "CORS error" sur login

**Cause** : Configuration Supabase Auth.

**Solution** : Aller dans Supabase ‚Üí Authentication ‚Üí URL Configuration ‚Üí Ajouter `http://localhost:3000` dans "Redirect URLs"

---

## üìö Ressources

**Documentation Officielle** :
- Supabase Auth : https://supabase.com/docs/guides/auth
- Next.js 15 + Supabase : https://supabase.com/docs/guides/auth/server-side/nextjs
- RLS : https://supabase.com/docs/guides/auth/row-level-security
- JWT : https://supabase.com/docs/guides/auth/jwts

**Exemples** :
- Template Next.js + Supabase : https://github.com/vercel/next.js/tree/canary/examples/with-supabase

---

**Version** : 1.0
**Date** : 2025-01-15
**Auteur** : Voipia Team
