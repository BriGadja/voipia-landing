# Prompt Dipler : Justification du Quality Score

**Date de cr√©ation** : 2025-01-20
**Auteur** : Claude
**Champ Dipler** : `callQualityAnalysis`
**Type** : `string` (texte long)

---

## üìã Prompt complet

```
Analyse cet appel et justifie son score de qualit√© en d√©taillant chaque crit√®re :

**1. Dur√©e de l'appel (sur 25 points)**
Indique la dur√©e exacte de l'appel et le nombre de points attribu√©s selon la grille :
- Moins de 30 secondes : 0 points (trop court, pas d'engagement)
- 30 √† 60 secondes : 10 points (engagement minimal)
- 60 √† 180 secondes : 25 points (dur√©e optimale)
- Plus de 180 secondes : 15 points (peut-√™tre trop long ou r√©p√©titif)

**2. Sentiment de la conversation (sur 30 points)**
Identifie le sentiment d√©tect√© et explique pourquoi :
- Positif : 30 points (client satisfait, conversation fluide)
- Neutre : 15 points (pas de friction, mais pas d'enthousiasme)
- N√©gatif : 0 points (frustration, incompr√©hension, col√®re)

**3. R√©sultat de l'appel (sur 30 points)**
Indique l'outcome et son impact sur le score :
- Rendez-vous programm√© : 30 points (objectif atteint)
- Demande de rappel : 20 points (int√©r√™t manifest√©)
- Refus de rendez-vous : 10 points (contact √©tabli, mais pas int√©ress√©)
- Messagerie vocale : 5 points (pas de contact direct)
- Pas de r√©ponse / Occup√© / √âchec : 0 points (pas de conversation)

**4. Fluidit√© technique - Latences LLM (sur 10 points)**
Indique la latence LLM moyenne et son √©valuation :
- < 500ms : 10 points (r√©activit√© excellente)
- 500-1000ms : 7 points (r√©activit√© correcte)
- 1000-1500ms : 4 points (quelques ralentissements)
- > 1500ms : 0 points (temps de r√©ponse trop longs)

**5. Fluidit√© technique - Latences TTS (sur 5 points)**
Indique la latence TTS moyenne et son √©valuation :
- < 300ms : 5 points (g√©n√©ration audio rapide)
- 300-500ms : 3 points (g√©n√©ration audio acceptable)
- > 500ms : 1 point (g√©n√©ration audio lente)

**Format de r√©ponse attendu :**
Structure ta r√©ponse en 3 sections courtes :

**D√âTAIL DES POINTS :**
- Dur√©e : [X] secondes ‚Üí [Y]/25 points
- Sentiment : [positif/neutre/n√©gatif] ‚Üí [Y]/30 points
- R√©sultat : [outcome] ‚Üí [Y]/30 points
- Latence LLM : [X]ms ‚Üí [Y]/10 points
- Latence TTS : [X]ms ‚Üí [Y]/5 points
**Total : [Score]/100**

**POINTS FORTS :**
[Liste 1-3 √©l√©ments qui ont bien fonctionn√©]

**AXES D'AM√âLIORATION :**
[Liste 1-3 √©l√©ments √† optimiser, ou "Aucun" si score parfait]

**Instructions importantes :**
- Sois concis mais pr√©cis (maximum 200 mots au total)
- Utilise des phrases courtes et des tirets pour la lisibilit√©
- Si des donn√©es manquent (ex: pas de latences), indique "Donn√©es non disponibles" et attribue 0 points
- Adapte le ton selon le score : encourageant si bon, constructif si moyen, analytique si faible
```

---

## üîß Configuration dans Dipler

### √âtape 1 : Ajouter le champ dans Dipler

1. Aller dans **Dipler > Agent Louis > Settings**
2. Section **"Post-Conversation Data Extraction"**
3. Cliquer sur **"Add Field"**
4. Configuration du champ :

```json
{
  "name": "callQualityAnalysis",
  "isRequired": false,
  "type": "string",
  "extractDataPrompt": "[COPIER LE PROMPT CI-DESSUS]"
}
```

**‚ö†Ô∏è Important** :
- `isRequired: false` ‚Üí Si l'analyse √©choue, ne bloque pas l'appel
- `type: "string"` ‚Üí Texte long (pas integer comme le score)
- Ce champ est **compl√©mentaire** √† `callQualityScore` (ne le remplace pas)

### √âtape 2 : Ordre des champs

Assurez-vous d'avoir les 2 champs dans cet ordre :
1. **callQualityScore** (integer) ‚Üí Le score num√©rique
2. **callQualityAnalysis** (string) ‚Üí La justification

---

## üîÑ Mise √† jour du workflow n8n

### Modification du node "Prepare Supabase Insert"

Ajouter le nouveau champ √† c√¥t√© de `call_quality_score` :

```javascript
{
  // Score num√©rique (existant)
  call_quality_score: $json.body.conversation.postConversationAnalysis.extractedData.callQualityScore || null,

  // Justification d√©taill√©e (NOUVEAU)
  call_quality_analysis: $json.body.conversation.postConversationAnalysis.extractedData.callQualityAnalysis || null,
}
```

---

## üìä Migration SQL : Ajouter la colonne

Cr√©er une migration pour ajouter la colonne `call_quality_analysis` √† `agent_calls` :

```sql
-- Migration: Add call_quality_analysis column
-- Date: 2025-01-20
-- Risk: LOW (adds column, no data loss)

BEGIN;

-- Add column for quality score justification
ALTER TABLE agent_calls
  ADD COLUMN IF NOT EXISTS call_quality_analysis TEXT;

-- Add comment
COMMENT ON COLUMN agent_calls.call_quality_analysis IS
  'Detailed justification for call_quality_score. Generated by Dipler post-conversation analysis.';

-- Add index for full-text search (optional, for future search features)
CREATE INDEX IF NOT EXISTS idx_agent_calls_quality_justification_fts
  ON agent_calls USING gin(to_tsvector('french', call_quality_analysis))
  WHERE call_quality_analysis IS NOT NULL;

COMMIT;

-- Verification
-- SELECT id, call_quality_score, call_quality_analysis
-- FROM agent_calls
-- WHERE call_quality_analysis IS NOT NULL
-- ORDER BY started_at DESC
-- LIMIT 5;
```

---

## üìù Exemple de r√©ponse attendue

Pour un appel de bonne qualit√© :

```
D√âTAIL DES POINTS :
- Dur√©e : 95 secondes ‚Üí 25/25 points
- Sentiment : positif ‚Üí 30/30 points
- R√©sultat : Rendez-vous programm√© ‚Üí 30/30 points
- Latence LLM : 650ms ‚Üí 7/10 points
- Latence TTS : 280ms ‚Üí 5/5 points
Total : 97/100

POINTS FORTS :
- Rendez-vous obtenu avec sentiment positif du client
- Dur√©e optimale permettant une conversation compl√®te
- G√©n√©ration audio fluide (TTS < 300ms)

AXES D'AM√âLIORATION :
- Latence LLM l√©g√®rement au-dessus de l'optimal (650ms vs 500ms cible)
- Envisager un mod√®le LLM plus rapide pour atteindre le score parfait
```

Pour un appel moyen :

```
D√âTAIL DES POINTS :
- Dur√©e : 48 secondes ‚Üí 10/25 points
- Sentiment : neutre ‚Üí 15/30 points
- R√©sultat : Refus de rendez-vous ‚Üí 10/30 points
- Latence LLM : 820ms ‚Üí 7/10 points
- Latence TTS : 390ms ‚Üí 3/5 points
Total : 45/100

POINTS FORTS :
- Contact √©tabli avec le prospect
- Performances techniques acceptables

AXES D'AM√âLIORATION :
- Appel trop court (48s) : d√©velopper davantage la proposition de valeur
- Sentiment neutre : travailler l'accroche et l'engagement √©motionnel
- R√©sultat n√©gatif : affiner le pitch et les objections
```

---

## üß™ Test du prompt

### Test 1 : Appel parfait

**Input** :
- Dur√©e : 120 secondes
- Sentiment : positif
- Outcome : appointment_scheduled
- Latence LLM : 450ms
- Latence TTS : 250ms

**Output attendu** : Score 100/100 avec justification √©logieuse

### Test 2 : Appel rat√©

**Input** :
- Dur√©e : 8 secondes
- Sentiment : n√©gatif
- Outcome : voicemail
- Latence LLM : 1800ms
- Latence TTS : 600ms

**Output attendu** : Score faible (~5/100) avec axes d'am√©lioration constructifs

---

## üí° Cas d'usage de la justification

### Dashboard Louis - D√©tail d'un appel

Afficher la justification dans un tooltip ou une modale au clic sur le score :

```typescript
<div className="flex items-center gap-2">
  <span className="text-2xl font-bold">{call.call_quality_score}/100</span>
  <Tooltip content={call.call_quality_analysis}>
    <InfoIcon className="w-4 h-4 text-white/50 cursor-help" />
  </Tooltip>
</div>
```

### Export CSV

Inclure la justification dans l'export pour analyse manuelle :

```typescript
{
  ...call,
  quality_score: call.call_quality_score,
  quality_justification: call.call_quality_analysis,
}
```

### Filtres avanc√©s

Permettre de filtrer les appels par points faibles d√©tect√©s :
- Afficher tous les appels avec "sentiment n√©gatif" dans la justification
- Filtrer par "latence LLM > 1000ms"
- Identifier les appels trop courts (<30s)

---

## üìö Diff√©rences avec le prompt score

| Crit√®re | Prompt Score | Prompt Justification |
|---------|--------------|---------------------|
| **Type de r√©ponse** | Integer (0-100) | String (texte structur√©) |
| **Longueur** | 1-3 caract√®res | ~150-200 mots |
| **Utilisation** | KPI, m√©triques, filtres | Analyse d√©taill√©e, coaching |
| **Champ Dipler** | `callQualityScore` | `callQualityAnalysis` |
| **Colonne SQL** | `call_quality_score` (INTEGER) | `call_quality_analysis` (TEXT) |
| **Performance** | Critique (calculs) | Secondaire (affichage) |

---

## üîí S√©curit√© et performance

### Tokens LLM

Le prompt justification consomme **~2-3x plus de tokens** que le prompt score :
- Prompt score : ~50 tokens input + 5 tokens output
- Prompt justification : ~150 tokens input + 100-150 tokens output

**Recommandation** : Acceptable car ex√©cut√© une fois par appel, stock√© en base.

### Privacy

La justification peut contenir des √©l√©ments de la conversation. Assurez-vous que :
- Les utilisateurs ayant acc√®s au dashboard ont le droit de voir ces d√©tails
- Les exports CSV respectent les permissions RLS
- La colonne `call_quality_analysis` suit les m√™mes r√®gles RLS que `agent_calls`

---

## üì¶ Checklist d'impl√©mentation

### Phase 1 : Backend (SQL)
- [ ] Cr√©er migration pour ajouter colonne `call_quality_analysis`
- [ ] Appliquer migration en staging
- [ ] Tester avec INSERT manuel
- [ ] Appliquer migration en production

### Phase 2 : Dipler
- [ ] Ajouter champ `callQualityAnalysis` dans Dipler
- [ ] Tester avec un appel r√©el
- [ ] V√©rifier format de la r√©ponse
- [ ] Ajuster prompt si n√©cessaire

### Phase 3 : n8n
- [ ] Mettre √† jour workflow `voipia-louis-endcall`
- [ ] Ajouter `call_quality_analysis` dans Prepare Supabase Insert
- [ ] Tester avec appel r√©el
- [ ] V√©rifier insertion en base

### Phase 4 : Frontend (optionnel)
- [ ] Ajouter colonne dans types TypeScript
- [ ] Afficher justification dans dashboard (tooltip/modale)
- [ ] Inclure dans export CSV
- [ ] Tester affichage

---

## üéØ R√©sultat final

Apr√®s impl√©mentation, chaque appel aura :

```sql
SELECT
  id,
  started_at,
  outcome,
  call_quality_score,           -- 85
  call_quality_analysis    -- "D√âTAIL DES POINTS : ..."
FROM agent_calls
WHERE call_quality_score IS NOT NULL
ORDER BY started_at DESC
LIMIT 1;
```

**B√©n√©fices** :
- ‚úÖ Score quantitatif pour m√©triques (KPIs, graphiques)
- ‚úÖ Justification qualitative pour coaching et am√©lioration
- ‚úÖ Transparence totale sur l'√©valuation
- ‚úÖ D√©tection automatique des axes d'am√©lioration

---

**Questions ?** R√©f√©rez-vous au `README.md` principal ou demandez √† Claude.
