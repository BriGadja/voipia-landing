{
  "nodes": [
    {
      "parameters": {
        "operation": "update",
        "tableId": "agent_calls",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('webhookCallEvent').item.json.body.conversation.config.sessionVariables.voipiaCallId }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "conversation_id",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.id }}"
            },
            {
              "fieldId": "call_sid",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.callInfos.callSid }}"
            },
            {
              "fieldId": "first_name",
              "fieldValue": "={{ $json.body.conversation.config.sessionVariables.prenom.toLowerCase().toTitleCase() }}"
            },
            {
              "fieldId": "last_name",
              "fieldValue": "={{ $json.body.conversation.config.sessionVariables.nom.toLowerCase().toTitleCase() }}"
            },
            {
              "fieldId": "email",
              "fieldValue": "={{ $json.body.conversation.config.sessionVariables.mail.toLowerCase().toTitleCase() }}"
            },
            {
              "fieldId": "phone_number",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.callInfos.humanPhoneNumber }}"
            },
            {
              "fieldId": "started_at",
              "fieldValue": "={{ new Date($('webhookCallEvent').item.json.body.conversation.sessionStartTime).toISOString() }}"
            },
            {
              "fieldId": "ended_at",
              "fieldValue": "={{ new Date($('webhookCallEvent').item.json.body.conversation.sessionEndTime).toISOString() }}"
            },
            {
              "fieldId": "duration_seconds",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.callInfos.callDuration }}"
            },
            {
              "fieldId": "direction",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.callInfos.direction }}"
            },
            {
              "fieldId": "call_status",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.callInfos.callStatus }}"
            },
            {
              "fieldId": "provider",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.callInfos.provider }}"
            },
            {
              "fieldId": "stt_cost",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.stats.sttStats.price }}"
            },
            {
              "fieldId": "tts_cost",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.stats.ttsStats.totalPrice }}"
            },
            {
              "fieldId": "llm_cost",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.stats.llmStats.totalPrice }}"
            },
            {
              "fieldId": "telecom_cost",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.callInfos.callCost }}"
            },
            {
              "fieldId": "dipler_commission",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.stats.diplerCommission }}"
            },
            {
              "fieldId": "total_cost",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.stats.sessionTotalPrice }}"
            },
            {
              "fieldId": "cost_per_minute",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.stats.averagePricePerMinute }}"
            },
            {
              "fieldId": "llm_model",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.stack.llm }}"
            },
            {
              "fieldId": "stt_provider",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.stack.stt }}"
            },
            {
              "fieldId": "tts_provider",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.stack.tts[0].ttsProvider }}"
            },
            {
              "fieldId": "tts_voice_id",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.stack.tts[0].voiceId }}"
            },
            {
              "fieldId": "recording_url",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.recordingSignedUrl }}"
            },
            {
              "fieldId": "transcript",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.transcript }}"
            },
            {
              "fieldId": "transcript_summary",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.postConversationAnalysis?.summary || '' }}"
            },
            {
              "fieldId": "call_quality_score",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.postConversationAnalysis?.extractedData?.callQualityScore || null }}"
            },
            {
              "fieldId": "call_quality_analysis",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.postConversationAnalysis?.extractedData?.callQualityAnalysis || null }}"
            },
            {
              "fieldId": "emotion",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.postConversationAnalysis?.sentiment || null }}"
            },
            {
              "fieldId": "outcome",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.postConversationAnalysis?.extractedData?.callClassification }}"
            },
            {
              "fieldId": "avg_llm_latency_ms",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.stats.latencies?.llmLatencies?.average || null }}"
            },
            {
              "fieldId": "min_llm_latency_ms",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.stats.latencies?.llmLatencies?.min || null }}"
            },
            {
              "fieldId": "max_llm_latency_ms",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.stats.latencies?.llmLatencies?.max || null }}"
            },
            {
              "fieldId": "avg_tts_latency_ms",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.stats.latencies?.ttsLatencies?.average || null }}"
            },
            {
              "fieldId": "min_tts_latency_ms",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.stats.latencies?.ttsLatencies?.min || null }}"
            },
            {
              "fieldId": "max_tts_latency_ms",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.stats.latencies?.ttsLatencies?.max || null }}"
            },
            {
              "fieldId": "avg_total_latency_ms",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.stats.latencies?.totalLatencies?.average || null }}"
            },
            {
              "fieldId": "min_total_latency_ms",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.stats.latencies?.totalLatencies?.min || null }}"
            },
            {
              "fieldId": "max_total_latency_ms",
              "fieldValue": "={{ $('webhookCallEvent').item.json.body.conversation.stats.latencies?.totalLatencies?.max || null }}"
            },
            {
              "fieldId": "metadata",
              "fieldValue": "={{ { workspaceId: $('webhookCallEvent').item.json.body.conversation.workspaceId, agentId: $('webhookCallEvent').item.json.body.conversation.agentId, agentName: $('webhookCallEvent').item.json.body.conversation.agentName, isTestEnvironment: $('webhookCallEvent').item.json.body.conversation.callInfos.isTestEnvironment, callPriceUnit: $('webhookCallEvent').item.json.body.conversation.callInfos.callPriceUnit, latencies: $('webhookCallEvent').item.json.body.conversation.stats.latencies, messageCount: $('webhookCallEvent').item.json.body.conversation.stats.messageCount, userMicRecordingUrl: $('webhookCallEvent').item.json.body.conversation.userMicRecordingSignedUrl, vadAudioRecordingUrl: $('webhookCallEvent').item.json.body.conversation.vadAudioRecordingSignedUrl } }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -880,
        1440
      ],
      "id": "6b9ae8c4-bf45-460f-8367-966dc7485d0d",
      "name": "Update a row",
      "credentials": {
        "supabaseApi": {
          "id": "XsVol30xDDqWJuLk",
          "name": "Voipia - Supabase"
        }
      }
    }
  ],
  "connections": {},
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "27a6c874b68318cdae94f2a582a89e9844ae4d79131f1180544dc868ad3bf428"
  }
}
