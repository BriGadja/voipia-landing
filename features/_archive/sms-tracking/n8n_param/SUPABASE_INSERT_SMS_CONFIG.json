{
  "nodes": [
    {
      "parameters": {
        "tableId": "agent_sms",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "deployment_id",
              "fieldValue": "={{ $('SetAgentData').item.json.deploymentId }}"
            },
            {
              "fieldId": "phone_number",
              "fieldValue": "={{ $('getSMSInfos').item.json.to }}"
            },
            {
              "fieldId": "message_content",
              "fieldValue": "={{ $('getSMSInfos').item.json.body }}"
            },
            {
              "fieldId": "message_type",
              "fieldValue": "notification"
            },
            {
              "fieldId": "provider",
              "fieldValue": "twilio"
            },
            {
              "fieldId": "provider_message_sid",
              "fieldValue": "={{ $('getSMSInfos').item.json.sid }}"
            },
            {
              "fieldId": "provider_status",
              "fieldValue": "={{ $('getSMSInfos').item.json.status }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "={{ $('getSMSInfos').item.json.status === 'delivered' ? 'delivered' : ($('getSMSInfos').item.json.status === 'failed' || $('getSMSInfos').item.json.status === 'undelivered' ? 'failed' : 'sent') }}"
            },
            {
              "fieldId": "sent_at",
              "fieldValue": "={{ new Date($('getSMSInfos').item.json.date_sent).toISOString() }}"
            },
            {
              "fieldId": "delivered_at",
              "fieldValue": "={{ $('getSMSInfos').item.json.status === 'delivered' ? new Date($('getSMSInfos').item.json.date_updated).toISOString() : null }}"
            },
            {
              "fieldId": "failure_reason",
              "fieldValue": "={{ $('getSMSInfos').item.json.error_message || null }}"
            },
            {
              "fieldId": "num_segments",
              "fieldValue": "={{ parseInt($('getSMSInfos').item.json.num_segments) || 1 }}"
            },
            {
              "fieldId": "cost_per_sms",
              "fieldValue": "={{ $('GetDeployment').item.json.cost_per_sms || 0.07 }}"
            },
            {
              "fieldId": "provider_cost_usd",
              "fieldValue": "={{ parseFloat($('getSMSInfos').item.json.price) }}"
            },
            {
              "fieldId": "exchange_rate_usd_eur",
              "fieldValue": "0.92"
            },
            {
              "fieldId": "currency",
              "fieldValue": "EUR"
            },
            {
              "fieldId": "workflow_id",
              "fieldValue": "={{ $workflow.id }}"
            },
            {
              "fieldId": "workflow_execution_id",
              "fieldValue": "={{ $execution.id }}"
            },
            {
              "fieldId": "metadata",
              "fieldValue": "={{ { workspaceId: $('SetAgentData').item.json.workspaceId, companyId: $('SetAgentData').item.json.companyId, agentId: $('SetAgentData').item.json.agentId, dealId: $('SetAgentData').item.json.dealId, fromPhoneNumber: $('SetAgentData').item.json.fromPhoneNumber, num_segments: $('getSMSInfos').item.json.num_segments, price_unit: $('getSMSInfos').item.json.price_unit, account_sid: $('getSMSInfos').item.json.account_sid } }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1200, 300],
      "id": "supabase-insert-sms",
      "name": "Supabase Insert SMS",
      "credentials": {
        "supabaseApi": {
          "id": "XsVol30xDDqWJuLk",
          "name": "Voipia - Supabase"
        }
      }
    }
  ],
  "connections": {},
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true
  }
}
